<script>
    @{
        @inject System.Net.Http.IHttpClientFactory clientFactory;
        var earthquakeController = new Epicentrum.Controllers.EarthquakeController(clientFactory);
        var epicentrumGeojson = earthquakeController.GetEpicentrumsGeoJson();
    }

    var geojsonReader = new ol.format.GeoJSON();
    var epicentrumGeojson = @Html.Raw(Json.Serialize(epicentrumGeojson));
    var epicentrumFeatures = geojsonReader.readFeatures(epicentrumGeojson);
    epicentrumFeatures.forEach(customizeFeature);

    var epicentrumSource = new ol.source.Vector({
        features: epicentrumFeatures
    });

    var epicentrumLayer = new ol.layer.Vector({
        source: epicentrumSource,
    });

    var backgroundLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });

    var map = new ol.Map({
        target: 'map',
        layers: [backgroundLayer, epicentrumLayer],
        view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]),
            zoom: 1
        })
    });

    function customizeFeature(feature) {
        feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
        feature.setStyle(getStyle(feature));
        return feature;
    }

    function getStyle(feature) {
        return new ol.style.Style({
            image: new ol.style.Circle({
                radius: 8,
                stroke: new ol.style.Stroke({
                    color: 'white'
                }),
                fill: new ol.style.Fill({
                    color: feature.get('color')
                })
            })
        });
    }

    var epicentrumInteraction = new ol.interaction.Select({
        condition: ol.events.condition.click,
        layers: [epicentrumLayer]
    });

    map.addInteraction(epicentrumInteraction);

    epicentrumInteraction.on('select', function (event) {
        getInfo(event);
    });

    function getInfo(event) {
        var selectedFeature = event.selected[0];
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "GET",
            url: "/Earthquake/Details/" + selectedFeature.getId(),
            success: function (details) { fillModal(details) },
            error: function (jqXHR) { console.log(jqXHR) }
        });
    }

    function fillModal(details) {
        document.getElementById('date').innerText = details.date;
        document.getElementById('country').innerText = details.country;
        document.getElementById('place').innerText = details.place;
        document.getElementById('magnitude').innerText = details.magnitude;
        document.getElementById('deaths').innerHTML = details.deaths;
        document.getElementById('earthquake').click();
    }
</script>
