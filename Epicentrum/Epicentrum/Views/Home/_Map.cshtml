<script>
    @{
        @inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment environment;
        var earthquakeController = new Epicentrum.Controllers.EarthquakeController(environment);
        var epicentrumGeojson = earthquakeController.GetEpicentrums();
    }

    var epicentrumGeojson = @Html.Raw(Json.Serialize(epicentrumGeojson));

    var epicentrumSource = new ol.source.Vector({
        features: getFeatures(epicentrumGeojson)
    });

    var epicentrumLayer = new ol.layer.Vector({
        source: epicentrumSource,
    });
    
    var backgroundLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });

    var map = new ol.Map({
        target: 'map',
        layers: [backgroundLayer, epicentrumLayer],
        view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]),
            zoom: 1
        })
    });

    function getFeatures(geojson) {
        var geojsonReader = new ol.format.GeoJSON();
        var features = geojsonReader.readFeatures(geojson);
        features.forEach(customizeFeature);
        return features;
    }

    function customizeFeature(feature) {
        feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
        feature.setStyle(getStyle(feature));
        return feature;
    }

    function getStyle(feature) {
        return new ol.style.Style({
            image: new ol.style.Circle({
                radius: 8,
                stroke: new ol.style.Stroke({
                    color: 'white'
                }),
                fill: new ol.style.Fill({
                    color: feature.get('color')
                })
            })
        });
    }

    var epicentrumInteraction = new ol.interaction.Select({
        condition: ol.events.condition.click,
        layers: [epicentrumLayer]
    });

    map.addInteraction(epicentrumInteraction);

    epicentrumInteraction.on('select', function (event) {
        getDetails(event);
    });

    function getDetails(event) {
        var selectedFeature = event.selected[0];
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "GET",
            url: "/Earthquake/Details/" + selectedFeature.getId(),
            success: function (details) { fillModal(details) },
            error: function (jqXHR) { console.log(jqXHR) }
        });
    }

    function fillModal(details) {
        document.getElementById('date').innerText = details.date.substring(0, details.date.indexOf('T'));
        document.getElementById('location').innerText = details.location;
        document.getElementById('magnitude').innerText = details.magnitude;
        document.getElementById('deaths').innerHTML = details.deaths;
        document.getElementById('earthquake').click();
    }

    function applyFilter() {
        var year = $('#yearFilter').val();
        var deaths = $('#deathsFilter').val();
        var url = "/Earthquake/GetEpicentrumsBy?year=" + year + "&deaths=" + deaths;
        getRequest(url);
        $('#filterModal').modal('hide');
    }

    function removeFilter() {
        var url = "/Earthquake/GetEpicentrums";
        getRequest(url);
        $('#filterModal').modal('hide');
        $('#yearFilter').val("");
        $('#deathsFilter').val("");
    }

    function getRequest(url) {
        $.ajax({
            contentType: "application/json; charset=utf-8",
            type: "GET",
            url: url,
            cache: false,
            success: function (data) { reloadFeatures(data) },
            error: function (jqXHR) { console.log(jqXHR) }
        });
    }

    function reloadFeatures(geojson) {
        var newFeatures = getFeatures(geojson);
        epicentrumLayer.getSource().clear();
        epicentrumLayer.getSource().addFeatures(newFeatures);
    }

</script>
