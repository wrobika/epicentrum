<script>
    @{
        @inject System.Net.Http.IHttpClientFactory clientFactory;
        var earthquakeController = new Epicentrum.Controllers.EarthquakeController(clientFactory);
        var epicentrumGeojson = earthquakeController.GetEpicentrumsGeoJson();
    }

    var geojsonReader = new ol.format.GeoJSON();
    var epicentrumGeojson = @Html.Raw(Json.Serialize(epicentrumGeojson));
    var epicentrumFeatures = geojsonReader.readFeatures(epicentrumGeojson);
    epicentrumFeatures.forEach(customizeFeature);

    var epicentrumSource = new ol.source.Vector({
        features: epicentrumFeatures
    });

    var epicentrumClusterSource = new ol.source.Cluster({
        distance: 30,
        source: epicentrumSource
    });

    var epicentrumLayer = new ol.layer.Vector({
        source: epicentrumClusterSource,
        style: function (feature) {
            return clusterStyle(feature);
        }
    });

    var backgroundLayer = new ol.layer.Tile({
        source: new ol.source.OSM()
    });

    var map = new ol.Map({
        target: 'map',
        layers: [backgroundLayer, epicentrumLayer],
        view: new ol.View({
            center: ol.proj.fromLonLat([0, 0]),
            zoom: 1
        })
    });

    function customizeFeature(feature) {
        feature.getGeometry().transform('EPSG:4326', 'EPSG:3857');
        return setFeatureStyle(feature);
    }

    function setFeatureStyle(feature) {
        feature.setStyle(new ol.style.Style({
            image: new ol.style.Circle({
                radius: 8,
                stroke: new ol.style.Stroke({
                    color: 'white'
                }),
                fill: new ol.style.Fill({
                    color: feature.get('color')
                })
            })
        }));
        return feature;
    }

    function clusterStyle(feature) {
        var style = feature.get('features')[0].getStyle();
        var size = feature.get('features').length;
        if (size !== 1) {
            style = new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 15,
                    stroke: new ol.style.Stroke({
                        color: 'black'
                    }),
                    fill: new ol.style.Fill({
                        color: 'white'
                    })
                }),
                text: new ol.style.Text({
                    text: size.toString(),
                    fill: new ol.style.Fill({
                        color: 'black'
                    })
                })
            });
        }
        return style;
    }
</script>
